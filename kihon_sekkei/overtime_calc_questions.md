# 月次残業時間計算関数 実装前確認事項

| 項目 | 内容 |
|------|------|
| 対象機能 | 月次残業時間の計算関数 |
| 作成日 | 2026-02-13 |
| 目的 | 実装着手前に仕様の曖昧な点を洗い出し、手戻りを防止する |

---

## 1. 丸め処理の仕様（8問）

| # | 質問 | 選択肢 | 影響範囲 |
|---|------|--------|---------|
| Q-01 | 15分単位の丸めは「切り捨て」「切り上げ」「四捨五入（7分30秒基準）」のいずれか？ | A) 切り捨て B) 切り上げ C) 四捨五入 | 残業時間の算出精度。切り上げと切り捨てで月間最大数時間の差が発生する |
| Q-02 | 丸めの対象は出勤・退勤の両方か、退勤のみか？ | A) 出退勤両方 B) 退勤のみ C) 残業時間の合計に対して | 出勤が9:07の場合、9:00扱いか9:15扱いかで所定労働時間の起算が変わる |
| Q-03 | 丸めは打刻時点で行うか、残業時間の算出時に行うか？ | A) 打刻記録時 B) 残業時間の算出時 | DB上の打刻データが丸め後の値か生の値かが変わる |
| Q-04 | 18:03に退勤した場合、残業時間は0分か15分か？ | A) 0分（18:00に切り捨て） B) 15分（18:15に切り上げ） | 短時間残業の計上可否。日次で数分の差だが月次で累積する |
| Q-05 | 17:50に退勤した場合の扱いは？ 18:00に丸められて残業0分となるか、17:45に切り捨てられて早退扱いか？ | A) 18:00に丸め→残業0分 B) 17:45に切り捨て→早退15分 C) そのまま17:50→早退10分 | 所定終業時刻前の退勤と丸めの優先順位 |
| Q-06 | 出勤が9:20の場合、遅刻として扱うか？ その場合の丸めは？ | A) 9:15扱い（切り捨て、遅刻なし） B) 9:30扱い（切り上げ、遅刻30分） C) 遅刻は丸めの対象外 | 遅刻時間と残業時間の相殺可否にも関わる |
| Q-07 | 休憩時間（12:00〜13:00）に丸めは適用されるか？ 12:55に休憩から戻った場合はどう扱うか？ | A) 休憩時間は固定1時間（丸め対象外） B) 休憩の戻り時刻も丸める | 実勤務時間の計算精度 |
| Q-08 | 丸めのルールは全社統一か、将来的に部署・拠点ごとに異なりうるか？ | A) 全社統一 B) 部署・拠点ごとに異なる可能性あり | 丸めロジックの設計（定数か設定テーブルか） |

---

## 2. 境界値（7問）

| # | 質問 | 具体例 | 影響範囲 |
|---|------|--------|---------|
| Q-09 | 「18時以降」は18:00ちょうどの退勤を含むか？ | 18:00退勤 → 残業0分？ 18:01退勤 → 残業が発生？ | 残業の起算タイミングの定義。「18:00超過」か「18:00以降」かで1分の差が生じる |
| Q-10 | 45時間超過の割増計算は、45時間ちょうどを含むか？ | 月45:00 → 通常？ 月45:01 → 割増？ | 割増計算の境界。「超えたら」は45:01以降か、45:00以降か |
| Q-11 | 45時間の割増は超過分のみに適用か、全体に適用か？ | 月50時間の場合、割増対象は5時間か50時間か | 給与計算への影響が大きい。超過分のみが一般的だが、確認が必要 |
| Q-12 | 日付またぎ勤務（0:00超過）の残業時間はどの月に計上するか？ | 1/31の23:00〜2/1の1:00勤務 → 1月？ 2月？ | 月末の残業時間集計に直結。requirement_v3.md REQ-034は「出勤打刻日」としている |
| Q-13 | 深夜勤務（22:00〜5:00）の割増は残業の割増と別途加算されるか？ | 22:00以降: 残業25% + 深夜25% = 50%？ | 割増率の複合適用ルール |
| Q-14 | 月の開始日は1日固定か、締め日が異なるか（例: 毎月20日締め）？ | A) 毎月1日〜末日 B) 毎月21日〜翌月20日 | 月次集計の期間定義。給与計算の締め日と一致させる必要がある |
| Q-15 | 残業時間が0分の日（18:00以前に退勤）は計算から除外してよいか、0分として記録すべきか？ | A) レコードなし B) 0分のレコードを作成 | 出勤日数と残業発生日数の集計方法に影響 |

---

## 3. 例外ケース（9問）

| # | 質問 | 具体例 | 影響範囲 |
|---|------|--------|---------|
| Q-16 | 退勤打刻がない日（打刻忘れ）の残業時間はどう扱うか？ | 出勤打刻のみ、退勤なし → 残業0分？ エラー？ 保留？ | 打刻補正申請（REQ-005）との連携。未補正のまま月次集計に含めるか |
| Q-17 | 打刻補正（REQ-005）で修正された退勤時刻は、丸め処理を再適用するか？ | 補正後の退勤を19:22 → 19:15に丸める？ そのまま19:22？ | 補正データの信頼性。上長承認済みの時刻を再丸めすべきか |
| Q-18 | 休日出勤は「別カウント」とのことだが、45時間の上限計算に含めるか含めないか？ | 通常残業40h + 休日出勤8h → 合計48h → 割増対象？ | 36協定の解釈。法定休日労働は36協定の月45時間に含まないのが一般的だが、確認が必要 |
| Q-19 | 休日出勤の全勤務時間が「残業」か、休日にも所定労働時間の概念があるか？ | 休日に9:00〜17:00勤務 → 8時間全部が休日残業？ | 休日出勤の時間計算の基準。法的には休日勤務は全時間が割増対象 |
| Q-20 | 半日有給を取得した日の残業はどう計算するか？ | 午後有給で13:00退勤 → 残業なし。午前有給で13:00出勤、20:00退勤 → 残業2時間？ 7時間勤務だが所定8時間未満 | 有給休暇と残業の組み合わせ。所定時間に満たない場合に残業が発生するかの判断 |
| Q-21 | 遅刻した日の残業は、遅刻分と相殺するか？ | 10:00出勤（1時間遅刻）、19:00退勤 → 残業1時間？ 残業0時間（遅刻と相殺）？ | 遅刻控除と残業の関係。法的には実労働時間ベースが一般的 |
| Q-22 | 残業申請が未承認・却下の場合、残業時間として計上するか？ | 打刻上は20:00退勤だが、残業申請が却下 → 残業2時間を計上する？ しない？ | REQ-043（サービス残業報告）との関係。計上しないとサービス残業を隠蔽する恐れ |
| Q-23 | 月途中の入退社の場合、45時間の上限は日割りするか？ | 15日入社 → 上限22.5時間？ それとも45時間のまま？ | 入退社月の残業管理ルール |
| Q-24 | システム障害による一括補正（REQ-040）のデータは、通常の打刻と同じ計算ロジックを適用するか？ | 障害期間中の推定退勤時刻 → 丸め処理を適用？ | 補正データの扱いの統一性 |

---

## 4. 入出力形式（6問）

| # | 質問 | 選択肢 | 影響範囲 |
|---|------|--------|---------|
| Q-25 | 入力データの形式は何か？ | A) `daily_work_summaries` テーブルのレコード配列 B) `time_stamps` の生打刻データ C) 両方を受け取る | 関数のインターフェース設計。サマリーから算出するか、生データから再計算するか |
| Q-26 | 出力する残業時間の単位は何か？ | A) 分（INT） B) 時間（DECIMAL, 小数点以下2桁） C) 時間:分（文字列 "HH:MM"） | APIレスポンス・画面表示・CSV出力で求められる形式が異なる可能性 |
| Q-27 | 割増計算の出力は時間数か金額か？ | A) 割増対象の時間数のみ B) 割増率を適用した金額 C) 両方 | 給与計算システムとの責務分離。本関数で金額まで算出するか |
| Q-28 | 割増率は何%か？ 45時間以内と超過分でそれぞれいくらか？ | 法定: 25%（通常残業）、50%超（月60時間超） | 割増率をハードコーディングするか、設定値として持つか |
| Q-29 | 戻り値に含めるべき内訳項目は何か？ | 例: 通常残業時間 / 45h超過分 / 休日出勤時間 / 深夜残業時間 | 画面表示・レポート・給与連携で必要な粒度 |
| Q-30 | エラー時の戻り値の形式は？ | A) 例外をスロー B) エラーコード付きオブジェクト C) NULLを返す | 呼び出し元のエラーハンドリング方針に合わせる必要がある |

---

## 優先度分類

### 実装着手前に必ず確認が必要（ブロッカー）

| 質問 | 理由 |
|------|------|
| **Q-01** 丸めの方向 | 全計算の基礎。後から変更すると全データに影響 |
| **Q-09** 18:00の扱い | 残業の起算定義。全日次計算に影響 |
| **Q-10, Q-11** 45時間の境界と割増対象範囲 | 給与計算に直結。誤ると法的リスク |
| **Q-14** 月の締め日 | 集計期間の定義。全月次計算に影響 |
| **Q-18** 休日出勤と45時間の関係 | 36協定の解釈に関わる法的判断 |
| **Q-25** 入力形式 | 関数シグネチャの決定。後から変更するとAPI全体に影響 |
| **Q-28** 割増率 | 計算結果に直結 |
| **Q-29** 戻り値の内訳 | 関数シグネチャの決定 |

### 実装中に確認すれば間に合う

| 質問 | 理由 |
|------|------|
| Q-02, Q-03, Q-04, Q-05, Q-06, Q-07 | 丸めの詳細ルール。Q-01の方向が決まれば順次確定可能 |
| Q-12, Q-13, Q-15 | 境界値の詳細。基本ロジック実装後に対応可能 |
| Q-26, Q-27, Q-30 | 出力形式。内部ロジック完成後に出力層で調整可能 |

### 将来的に確認が必要（初期リリースでは仮定で進めてよい）

| 質問 | 理由 |
|------|------|
| Q-08 | 丸めルールの拠点差異。初期は全社統一で問題ない |
| Q-16, Q-17, Q-20, Q-21, Q-22, Q-23, Q-24 | 例外ケース。初期は最もシンプルなルールで実装し、運用で判明した課題に応じて拡張 |
| Q-19 | 休日出勤の詳細。初期は全時間を休日勤務として計上すれば法的に問題ない |
