# データモデル設計 最終決定書

| 項目 | 内容 |
|------|------|
| 文書ID | DEC-002 |
| 決定日 | 2026-02-13 |
| 関連文書 | datamodels.md, scoring.md, scenarios.md |
| 準拠要件 | requirement_v3.md（REQ-DOC-001 v3.0） |
| ステータス | **決定済み** |

---

## 1. 決定事項

### 採用案: 案B（バランス型）＋ 案Cからの選択的先行導入

案Bの9テーブル構成をベースとし、案Cから将来の拡張に備えた2テーブル（`work_patterns`, `company_calendar`）を先行導入する **折衷案** を採用する。

**最終テーブル構成: 11テーブル**

| # | テーブル名 | 出自 | 役割 |
|---|-----------|:----:|------|
| 1 | `employees` | 案B | 従業員マスタ |
| 2 | `departments` | 案B | 部署マスタ |
| 3 | `time_stamps` | 案B | 打刻の生データ |
| 4 | `daily_work_summaries` | 案B | 日次勤務サマリー |
| 5 | `overtime_requests` | 案B | 残業申請（事前/事後） |
| 6 | `approval_histories` | 案B | 承認履歴 |
| 7 | `overtime_limit_requests` | 案B | 月45時間超過の人事部承認 |
| 8 | `monthly_summaries` | 案B | 月次集計（非正規化） |
| 9 | `audit_logs` | 案B | 監査証跡 |
| 10 | `work_patterns` | **案C** | 勤務パターン定義 |
| 11 | `company_calendar` | **案C** | 会社カレンダー（営業日/休日） |

---

## 2. 決定根拠

### 2.1 評価データの統合

| 評価 | 案A | 案B | 案C | 出典 |
|------|:---:|:---:|:---:|------|
| 現時点の総合力（50点満点） | 35 | **37** | 32 | scoring.md |
| 将来シナリオ対応力（低いほど良い） | 12 | 8 | **4** | scenarios.md |
| requirement_v3.md 要件充足度 | △ | **○** | ○ | datamodels.md |

案Bは現時点の総合力で最高スコア（37点）を獲得し、5軸すべてで7点以上と弱点がない。一方、将来シナリオ対応力では案C（4点）が圧倒的に優れている。

**純粋な案B採用のリスク:** シフト管理（難易度3）と拠点別祝日（難易度3）の対応で中規模改修が必要になる。これらの改修の根本原因は「勤務パターンマスタ」と「カレンダーマスタ」の不在である。

**折衷案の狙い:** この2テーブルを案Cから先行導入することで、将来シナリオ1・3の対応難易度を大幅に下げつつ、案Bのシンプルさと実装コストの優位を維持する。

### 2.2 先行導入する2テーブルの選定理由

| テーブル | 先行導入する理由 | 導入しない場合のリスク |
|---------|----------------|---------------------|
| `work_patterns` | 初期リリース時は「通常勤務（9:00〜18:00）」の1レコードのみ登録し、`daily_work_summaries` から参照する。シフト管理追加時にマスタデータの追加だけで対応可能になる | シフト管理追加時にテーブル新設 + 既存テーブルのスキーマ変更 + 計算ロジック全面改修（難易度3→1に低減） |
| `company_calendar` | 初期リリース時は当年の営業日/土日祝を一括登録する。「翌営業日」の判定ロジックをこのテーブル参照に統一できる | 拠点別祝日対応時にテーブル新設 + 営業日判定ロジックの全面書換え（難易度3→2に低減） |

### 2.3 案Cから導入しないものの理由

| 案Cの要素 | 不採用理由 |
|----------|----------|
| `employee_assignments`（所属履歴） | 現時点では `employees.department_id` / `manager_id` の直接参照で十分。異動頻度が高くなった時点で検討する |
| `workflow_requests` + `workflow_request_details`（汎用ワークフロー） | EAVパターンの複雑さが保守性を下げる。残業申請は `overtime_requests` の専用テーブルで十分対応可能 |
| `approval_steps`（多段承認定義） | 現行要件は上長→人事部の2段階のみ。汎用承認エンジンは過剰 |
| `notifications`（通知テーブル） | 通知は外部サービス（メール/プッシュ通知）に委譲し、DBで管理しない方針とする |
| `stamp_events`（イベントソーシング） | 追記のみのイベントモデルは堅牢だが、`time_stamps` + `audit_logs` で同等の追跡が可能。導入コストに見合わない |

---

## 3. 折衷案による改善効果

### scoring.md の5軸での変化

| 評価軸 | 案B（純粋） | 折衷案 | 変化 | 理由 |
|--------|:----------:|:------:|:----:|------|
| パフォーマンス | 8 | 8 | → | テーブル2つの追加は軽微。カレンダー参照はインデックスで高速 |
| 拡張性 | 7 | **8** | +1 | シフト・カレンダーの基盤が整い、将来の拡張が容易になる |
| 保守性 | 7 | 7 | → | テーブル2つの追加は理解の負担にならない範囲 |
| 実装コスト | 7 | **6** | -1 | テーブル2つとマスタ管理の初期投入コストが増加 |
| データ整合性 | 8 | 8 | → | カレンダーの一元管理でむしろ整合性は改善傾向 |
| **合計** | **37** | **37** | → | 拡張性の向上とコスト増が相殺 |

### scenarios.md のシナリオ対応力の変化

| シナリオ | 案B（純粋） | 折衷案 | 改善 |
|---------|:----------:|:------:|:----:|
| 1. シフト管理追加 | 3 | **2** | -1（パターンマスタ追加が不要に） |
| 2. 従業員数10倍 | 2 | 2 | → |
| 3. 拠点別祝日 | 3 | **2** | -1（カレンダー基盤が既存に） |
| **合計** | **8** | **6** | **-2** |

---

## 4. 実装時の注意事項

### `work_patterns` の初期運用

```
初期データ: 1レコードのみ
  - name: "通常勤務"
  - start_time: 09:00
  - end_time: 18:00
  - break_minutes: 60
  - standard_work_minutes: 480
```

- `daily_work_summaries` に `work_pattern_id` カラムを追加し、初期値として上記レコードのIDを設定する
- 残業時間の計算ロジックは `work_patterns.standard_work_minutes` を参照する形で実装する（ハードコーディング禁止）

### `company_calendar` の初期運用

- 年初に当年分の全日付を一括登録するバッチを実装する
- 土日は `holiday_prescribed`、祝日は `holiday_statutory`、平日は `working` として登録
- 「翌営業日」の判定は全箇所でこのテーブルを参照するよう統一する

### datamodels.md の案Bからの差分

`daily_work_summaries` に以下のカラムを追加する。

| カラム | 型 | 説明 |
|-------|-----|------|
| `work_pattern_id` | BIGINT FK | `work_patterns.id` への参照 |

---

## 5. 不採用案の記録

| 案 | 不採用理由 |
|----|-----------|
| 案A: シンプル型 | 現時点の総合力（35点）が案Bに劣り、拡張性（3点）とデータ整合性（4点）が著しく低い。REQ-042（事後申請率）・REQ-022（監査証跡）の要件充足にも構造的な制約がある。将来シナリオではシフト管理で再設計レベル（難易度5）の対応が必要 |
| 案C: 高拡張性型（全面採用） | 将来対応力は最高だが、現時点の実装コスト（3点）・保守性（4点）が低い。14テーブル＋汎用ワークフロー＋EAVパターンは500名規模に対して過剰。必要な2テーブルのみ選択的に導入する折衷案で、案Cの利点を低コストで取り込む |

---

## 6. 今後の拡張判断基準

以下の条件が発生した時点で、案Cの追加要素の導入を検討する。

| トリガー | 導入を検討する案Cの要素 |
|---------|----------------------|
| フレックスタイム制・シフト制の正式導入が決定 | `employee_assignments`（従業員×パターンの割当て履歴） |
| 承認ルートが3段階以上に複雑化 | `approval_steps`（多段承認定義） |
| 従業員数が1,000名を超過 | `stamp_events`（イベントソーシング方式への移行検討） |
| 申請種別が5種類以上に増加 | `workflow_requests`（汎用ワークフローへの統合検討） |
