# 将来シナリオ別 対応難易度評価

| 項目 | 内容 |
|------|------|
| 対象文書 | kihon_sekkei/datamodels.md |
| 評価日 | 2026-02-13 |
| 評価方式 | 対応難易度を5段階で評価（1=容易 〜 5=再設計レベル） |

---

## 評価サマリー

| シナリオ | 案A: シンプル型 | 案B: バランス型 | 案C: 高拡張性型 |
|---------|:--------------:|:--------------:|:--------------:|
| 1. シフト管理機能の追加 | **5** 再設計 | **3** 中規模改修 | **1** 設定追加 |
| 2. 従業員数10倍（5,000名） | **3** 中規模改修 | **2** 軽微な改修 | **2** 軽微な改修 |
| 3. 拠点ごとの祝日設定 | **4** 大規模改修 | **3** 中規模改修 | **1** 設定追加 |
| **合計（低いほど良い）** | **12** | **8** | **4** |

---

## シナリオ1: シフト管理機能の追加（早番・遅番など）

### 要件の想定

- 早番（6:00〜15:00）、遅番（14:00〜23:00）、夜勤（22:00〜7:00）等の複数シフトを定義
- 従業員ごとに月単位でシフトを割当て
- シフトに応じて所定労働時間・残業起算時刻が変わる

---

### 案A: シンプル型 ― 難易度 5（再設計レベル）

**現状の問題点:**
`daily_attendances` は所定労働時間が「9:00〜18:00固定」を前提にハードコーディングされている。残業時間の計算ロジック（`overtime_minutes`）が1つの勤務パターンしか想定しておらず、シフトごとに異なる残業起算時刻を扱えない。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| シフトマスタテーブルの新規追加 | テーブル追加 |
| シフト割当てテーブルの新規追加 | テーブル追加 |
| `daily_attendances` にシフトIDカラムの追加 | スキーマ変更 |
| 残業時間の計算ロジックをシフト基準に全面書換え | **アプリ層の大規模改修** |
| 日付またぎ勤務の判定ロジック変更（夜勤対応） | **アプリ層の大規模改修** |
| 既存データのマイグレーション（全レコードにシフトIDを付与） | データ移行 |

**影響範囲:** テーブル追加2つ + スキーマ変更1つ + 計算ロジックの全面書換え。残業時間の計算が `daily_attendances` に密結合しているため、打刻・残業申請・集計のすべてに影響が波及する。実質的にデータモデルの再設計に近い。

---

### 案B: バランス型 ― 難易度 3（中規模改修）

**現状の問題点:**
勤務パターンがテーブルとして存在せず、所定労働時間はアプリ層の定数として管理されている。`daily_work_summaries` の `work_minutes` / `overtime_minutes` の計算ロジックがシフト非対応。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| 勤務パターンマスタテーブルの新規追加 | テーブル追加 |
| シフト割当てテーブルの新規追加 | テーブル追加 |
| `daily_work_summaries` にパターンIDカラムの追加 | スキーマ変更 |
| 勤務時間・残業時間の計算ロジックをパターン参照に変更 | アプリ層の改修 |
| `monthly_summaries` の再集計バッチの修正 | アプリ層の改修 |

**影響範囲:** テーブル追加2つ + スキーマ変更1つ + 計算ロジックの改修。打刻テーブル（`time_stamps`）と残業申請テーブル（`overtime_requests`）は変更不要。計算ロジックが `daily_work_summaries` の更新処理に集約されているため、影響範囲は案Aより限定的。

---

### 案C: 高拡張性型 ― 難易度 1（設定追加のみ）

**現状の対応状況:**
`work_patterns` テーブルが既に存在し、`start_time` / `end_time` / `break_minutes` / `standard_work_minutes` でシフトを定義できる。`daily_records` は `work_pattern_id` で勤務パターンを参照済み。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| `work_patterns` にシフトデータを登録 | マスタデータ追加 |
| シフト割当てテーブルの新規追加（従業員×月×シフト） | テーブル追加 |
| シフト割当てのUIと管理画面の実装 | フロントエンド追加 |

**影響範囲:** テーブル追加1つ + マスタデータ登録。既存のスキーマ変更なし、計算ロジックの変更なし。`daily_records.work_pattern_id` の参照先が増えるだけで、残業計算ロジックはパターンの `standard_work_minutes` を基準に動的に算出する設計が既にできている。

---

## シナリオ2: 従業員数が10倍（5,000名）に増加

### 要件の想定

- 現行 500名 → 5,000名
- 朝の出勤ピーク時の同時アクセスが500 → 5,000
- 5年間のデータ量: 約91万行 → 約912万行（日次レコード基準）

---

### 案A: シンプル型 ― 難易度 3（中規模改修）

**現状の問題点:**
`daily_attendances` は1テーブルに打刻・残業・承認の全カラムを集約しているため、レコードあたりのサイズが大きい（約30カラム）。912万行×30カラムの全件スキャンが月次集計で発生する。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| `daily_attendances` のパーティショニング（年月単位） | DB設定変更 |
| 月次集計用のサマリーテーブルの新規追加 | テーブル追加 + バッチ実装 |
| インデックスの見直し・追加 | DB設定変更 |
| リードレプリカの導入（参照系の負荷分散） | インフラ変更 |
| 朝のピーク対応のためコネクションプール拡張 | インフラ変更 |

**影響範囲:** 月次集計のサマリーテーブルが存在しないため、新規追加とバッチ処理の実装が必要。これは実質的に案Bの `monthly_summaries` を後追いで導入することになり、設計方針の転換を含む。

---

### 案B: バランス型 ― 難易度 2（軽微な改修）

**現状の対応状況:**
`monthly_summaries` による非正規化テーブルが既に存在し、月次集計は事前計算済み。打刻テーブル（`time_stamps`）と日次サマリー（`daily_work_summaries`）が分離されており、参照パターンに応じた最適化が可能。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| `time_stamps` のパーティショニング（年月単位） | DB設定変更 |
| インデックスの見直し・追加 | DB設定変更 |
| リードレプリカの導入 | インフラ変更 |
| コネクションプールの拡張 | インフラ変更 |

**影響範囲:** スキーマ変更・アプリ層の改修は不要。インフラレベルのスケーリングで対応可能。`monthly_summaries` が既にあるため、月次レポートのパフォーマンス劣化も限定的。

---

### 案C: 高拡張性型 ― 難易度 2（軽微な改修）

**現状の対応状況:**
案Bと同等の `monthly_summaries` を持ち、イベントテーブル（`stamp_events` / `approval_events`）は追記のみのため、パーティショニングとの相性が良い。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| `stamp_events` / `approval_events` のパーティショニング | DB設定変更 |
| `audit_logs` のパーティショニングまたはアーカイブ戦略 | DB設定変更 |
| リードレプリカの導入 | インフラ変更 |
| `workflow_request_details`（EAV）のクエリ最適化 | アプリ層の軽微な改修 |

**影響範囲:** 案Bとほぼ同等。ただし `workflow_request_details` のEAVパターンはレコード数がワークフロー申請の属性数倍に膨れるため、5,000名規模ではクエリ最適化（バッチフェッチ、キャッシュ）の検討が必要。この点で案Bよりわずかに手間がかかる。

---

## シナリオ3: 拠点ごとの祝日設定への対応

### 要件の想定

- 東京本社・大阪支社・海外拠点で異なる祝日カレンダーを設定
- 拠点ごとに所定休日・法定休日が異なる
- 従業員は所属拠点のカレンダーに従って勤務日が判定される

---

### 案A: シンプル型 ― 難易度 4（大規模改修）

**現状の問題点:**
カレンダーマスタが存在しない。営業日の判定はアプリ層のロジック（土日＝休日の固定ルール）に依存しており、拠点という概念自体がデータモデルにない。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| 拠点マスタテーブルの新規追加 | テーブル追加 |
| 拠点別カレンダーテーブルの新規追加 | テーブル追加 |
| `employees` に拠点IDカラムの追加 | スキーマ変更 |
| `daily_attendances.work_type` の値の拡張（法定休日/所定休日の区分） | スキーマ変更 |
| 営業日判定ロジックの全面書換え（固定ルール → カレンダー参照） | **アプリ層の大規模改修** |
| 残業申請期限の「翌営業日」判定ロジックの改修 | アプリ層の改修 |
| 休日出勤の割増区分判定の改修 | アプリ層の改修 |
| 既存データへの拠点ID付与マイグレーション | データ移行 |

**影響範囲:** テーブル追加2つ + スキーマ変更2つ + 営業日判定ロジックの全面書換え。「営業日」の定義がシステム全体に散在しているため（残業申請期限、退勤リマインド、事後申請率集計など）、影響範囲が広い。

---

### 案B: バランス型 ― 難易度 3（中規模改修）

**現状の問題点:**
カレンダーマスタが存在しない。拠点の概念もデータモデルにない。ただし、`daily_work_summaries.work_type` に勤務区分があり、休日出勤の区分は既に対応している。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| 拠点マスタテーブルの新規追加 | テーブル追加 |
| 拠点別カレンダーテーブルの新規追加 | テーブル追加 |
| `employees` に拠点IDカラムの追加 | スキーマ変更 |
| 営業日判定ロジックをカレンダー参照に変更 | アプリ層の改修 |
| `daily_work_summaries.work_type` の拡張（法定/所定の区分追加） | スキーマ変更 |

**影響範囲:** テーブル追加2つ + スキーマ変更2つ。案Aと同じ追加要素だが、勤務区分が既に `daily_work_summaries` で分離管理されているため、影響範囲は打刻テーブルや残業申請テーブルに波及しない。営業日判定の修正箇所もアプリ層に集約しやすい。

---

### 案C: 高拡張性型 ― 難易度 1（設定追加のみ）

**現状の対応状況:**
`company_calendar` テーブルが既に存在し、`day_type`（working / holiday_statutory / holiday_prescribed / company_holiday）で日種別を管理している。`daily_records.work_type` も法定休日/所定休日を区分済み。

**必要な修正:**

| 修正内容 | 規模 |
|---------|------|
| 拠点マスタテーブルの新規追加 | テーブル追加 |
| `company_calendar` に拠点IDカラムの追加（拠点NULLは全社共通） | スキーマ変更（軽微） |
| `employees` に拠点IDカラムの追加（または `employee_assignments` に追加） | スキーマ変更（軽微） |
| カレンダー参照ロジックに拠点フィルタを追加 | アプリ層の軽微な改修 |

**影響範囲:** テーブル追加1つ + 軽微なスキーマ変更2つ。カレンダーの仕組みが既に存在するため、拠点軸を追加するだけで対応完了。営業日判定ロジックは既にカレンダー参照方式のため、フィルタ条件の追加のみ。

---

## 総合分析

### 対応難易度合計（低いほど良い）

```
案C（4点）<< 案B（8点）< 案A（12点）
```

### 各案の将来対応力

| 案 | 強いシナリオ | 弱いシナリオ | 総評 |
|----|------------|------------|------|
| A | なし | シフト管理（再設計）、拠点祝日（大規模改修） | 3シナリオすべてで最も対応コストが高い。短期的なコスト優位が将来の技術的負債に直結する |
| B | 従業員数増加（インフラのみ） | シフト管理・拠点祝日（中規模改修） | 中規模改修で対応可能な範囲に収まる。ただしシフト・カレンダーの仕組みは後追いで構築が必要 |
| C | 全シナリオ | なし | 3シナリオすべてで設定追加または軽微な改修のみ。初期コストの高さが将来の変更容易性として回収される |

### scoring.md との総合判断

| 評価 | 案A | 案B | 案C |
|------|:---:|:---:|:---:|
| 現時点の総合力（scoring.md） | 35点 | **37点** | 32点 |
| 将来シナリオ対応力（本書） | 12点 | 8点 | **4点** |

現時点の要件充足では案Bが最も優れているが、**将来シナリオへの対応力では案Cが圧倒的**である。

プロジェクトの判断ポイントは「シフト管理・拠点展開がいつ発生するか」にある。

- **1〜2年以内に発生する見込みがない** → 案Bを採用し、必要になった時点で段階的に拡張
- **1年以内に発生する可能性が高い** → 案Cの初期投資を正当化できるため、案Cを検討すべき
- **判断がつかない** → 案Bを採用しつつ、案Cの `work_patterns` と `company_calendar` のみ先行導入する折衷案も有効
